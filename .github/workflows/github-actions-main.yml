name: Python + PostgreSQL Application
on:
  push:
    branches: [main]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build the stack
        run: docker compose up -d --build
  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v2
      - name: Smoke test
        run: |
              sleep 10
              status_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/posts)
              if [[ "$status_code" -eq 200 ]]; then
                echo "success"
                exit 0
                  else
                echo "$status_code" 
                exit 1
              fi